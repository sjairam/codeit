# Documentation

This uses Sphinx 7 as a documentation framework to build Confluence wiki pages.

## Usage

Copy `./example.env` to `./.env` and adjust the values for your local user.
Review `./source/conf.py` to check how things get published to Confluence.

To start editing, run via Docker Compose:
```bash
docker compose run --rm --build -p 8000:8000 sphinx-autobuild
```

Then connect to `localhost:8000` for the live HTML previewer.

### Publishing

> [!WARNING]
> By default, a publishing dryrun is done.
> Publish by setting `CONFLUENCE_PUBLISH_DRYRUN=false`.
>
> Dryruns will additionally list pages to be removed.
> However, no destructive page deletions will actually be published.
> If you need to remove pages, use the dryrun logs to manually remove them.

To build docs, run:
```bash
# Dryrun
docker compose run -it --rm --build sphinx-dryrun
# Publish
docker compose run -it --rm sphinx-publish

Alternatively, you can use `act` (see top-level README) to publish using the `docs.yml`
Github Actions workflow. Place the following in your `act.secrets` file:

``` conf
MOD_AUTH_CAS_S=xxxxxxxxxxxxxxxxx
JSESSIONID=xxxxxxxxxxxxxxxxxxxxx
CONFLUENCE_SERVER_USER='xxxxxx'
```
Then run:

``` bash
act -W .github/workflows/docs.yml -P self-hosted=catthehacker/ubuntu:act-latest --secret-file act.secrets
```
You will need to provide login details to publish remotely (see below).

## Confluence Authentication

Authentication can vary depending on if you're using Confluence Server or Cloud.

On Confluence Server, use one of these:
- Best option is using a new [personal access token](https://confluence.atlassian.com/enterprise/using-personal-access-tokens-1026032365.html).
  Note that this option may be disabled by default for non-admin users.
- Easiest alternative is to extract your login cookie and use that:
  1. Use your browser to login to Confluence Server.
  2. Open your browser's devtool inspector console, and select the Storage tab.
  3. Use the sidebar to find your cookies, and note the
    `MOD_AUTH_CAS_S`/`JSESSIONID` values.

On Confluence Cloud, create a new [API token](https://support.atlassian.com/atlassian-account/docs/manage-api-tokens-for-your-atlassian-account/).

The personal access token or API token replaces your password during auth.
The cookie value must be placed in the `.env` config you're using.

If using cookie or API token, also provide your username (Server) or email
(Cloud).
This can be looked up in brower, by going to:
`{CONFLUENCE_BASE_URL}/rest/api/user/current`.

> [!WARNING]
> Don't log out in browser if using cookies, until you're done publishing.

## Writing Docs

Documentation goes in `./source/`, with `_static/` for assets and `_templates/`
for adding custom templating (using Jinja2).
The `_generated` folder is used for staging autogenerated assets used by
Sphinx.

Documentation can be written in MyST-style Markdown (`.md` files), or with
Sphinx-style reStructuredText (`.rst` files).
- https://myst-parser.readthedocs.io/en/latest/syntax/typography.html
- https://www.sphinx-doc.org/en/master/usage/restructuredtext/index.html

You can use DrawIO to create diagrams in `./source/_static/diagrams`.
It's recommended to save as SVG, then let Sphinx do the needed conversions.

There is also Confluence-specific markup extensions available to use, but may
not render correctly in `sphinx-autobuild` preview mode.
- https://sphinxcontrib-confluencebuilder.readthedocs.io/en/stable/directives/
- https://sphinxcontrib-confluencebuilder.readthedocs.io/en/stable/roles/

It's recommended to use cross-builder compatible extensions instead.
For a full list of compatible extensions, see the Sphinx Confluence builder docs.
- https://sphinxcontrib-confluencebuilder.readthedocs.io/en/stable/features/

### Python Docstrings Automation

Python code in the `/dags` and `/plugins` folder will have documentation
generated by `sphinx-autoapi` during builds.
This will create a summary of all parameters, classes, functions, etc. in each
file, based on their docstrings and type annotations.

Docstrings follow the Numpy style convention, and are written in reST syntax.
For an overview of writing docstrings in code, see:
- https://www.sphinx-doc.org/en/master/usage/extensions/napoleon.html

name: Ruby SAST Scan

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  schedule:
    - cron: '0 0 * * 0'

jobs:
  sast-scan:
    name: Run Ruby SAST Scan
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true

    - name: Install SAST tools
      run: |
        gem install brakeman bundler-audit dawnscanner rubocop rubocop-rails rubocop-performance
        python -m pip install semgrep

    - name: Run Brakeman
      id: brakeman
      run: |
        brakeman -q -w2 --no-progress -c config/brakeman.yml \
        --format json --output brakeman-report.json \
        --format html --output brakeman-report.html
      continue-on-error: true

    - name: Process Brakeman Results
      if: always()
      run: |
        if [ -f brakeman-report.json ]; then
          # Extract warnings and create GitHub annotations
          jq -r '.warnings[] | "::warning file=\(.file),line=\(.line),col=\(.column)::\(.message)"' brakeman-report.json >> $GITHUB_STEP_SUMMARY
          
          # Count warnings by confidence level
          HIGH_WARNINGS=$(jq '.warnings | map(select(.confidence == "High")) | length' brakeman-report.json)
          MEDIUM_WARNINGS=$(jq '.warnings | map(select(.confidence == "Medium")) | length' brakeman-report.json)
          LOW_WARNINGS=$(jq '.warnings | map(select(.confidence == "Weak")) | length' brakeman-report.json)
          
          # Add summary to step output
          echo "## Brakeman Security Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- High confidence warnings: $HIGH_WARNINGS" >> $GITHUB_STEP_SUMMARY
          echo "- Medium confidence warnings: $MEDIUM_WARNINGS" >> $GITHUB_STEP_SUMMARY
          echo "- Low confidence warnings: $LOW_WARNINGS" >> $GITHUB_STEP_SUMMARY
          
          # Set output variables for other steps
          echo "high_warnings=$HIGH_WARNINGS" >> $GITHUB_OUTPUT
          echo "medium_warnings=$MEDIUM_WARNINGS" >> $GITHUB_OUTPUT
          echo "low_warnings=$LOW_WARNINGS" >> $GITHUB_OUTPUT
          
          # Fail if there are high confidence warnings
          if [ "$HIGH_WARNINGS" -gt 0 ]; then
            echo "::error::Found $HIGH_WARNINGS high confidence security warnings"
            exit 1
          fi
        else
          echo "::error::Brakeman report not generated"
          exit 1
        fi

    - name: Run bundle-audit
      run: |
        bundle-audit check --update
        bundle-audit check --format json > bundle-audit-report.json

    - name: Run DawnScanner
      run: |
        dawn -u
        dawn -j -o dawn-report.json

    - name: Run RuboCop security checks
      run: |
        rubocop --require rubocop-rails --require rubocop-performance \
        --format json --out rubocop-report.json \
        --only Security/Open, Security/Eval, Security/MarshalLoad, \
        Security/JSONLoad, Security/YAMLLoad, Security/CommandInjection, \
        Security/FilePath, Rails/OutputSafety

    - name: Run Semgrep
      run: |
        semgrep --config=p/ruby --config=p/rails \
        --json -o semgrep-report.json \
        --exclude-dir=vendor --exclude-dir=node_modules

    - name: Upload all results
      uses: actions/upload-artifact@v4
      with:
        name: sast-results
        path: |
          brakeman-report.*
          bundle-audit-report.json
          dawn-report.json
          rubocop-report.json
          semgrep-report.json
        retention-days: 7 
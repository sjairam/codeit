#!/bin/bash
# v0.1 - initial - Find all reserved memory instances in Kubernetes cluster
# Finds pods with memory requests (reserved memory) across namespaces

# Color definitions
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
MAGENTA='\033[0;35m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

KUBECTL=$(command -v kubectl)

# Function to display help options
Help() {
    echo -e "${BLUE}Find all reserved memory instances (memory requests) in a Kubernetes cluster${NC}"
    echo
    echo -e "${CYAN}Syntax: $0 [-h] [-n namespace] [-a] [-s]${NC}"
    echo -e "${YELLOW}options:${NC}"
    echo -e "-h                     Print this message."
    echo -e "-n namespace          Search in specific namespace only."
    echo -e "-a                     Show all namespaces (default)."
    echo -e "-s                     Sort by memory size (descending)."
    echo
    echo -e "${CYAN}Examples:${NC}"
    echo -e "  $0                    # Show all reserved memory in all namespaces"
    echo -e "  $0 -n default         # Show reserved memory in default namespace"
    echo -e "  $0 -s                 # Show all reserved memory sorted by size"
    echo
    echo -e "Pods with >25% discrepancy between actual usage and reserved requests are ${RED}highlighted in red${NC}."
    echo
}

# Function to check the availability of required binaries
check_binaries() {
    if [ -z "${KUBECTL}" ]; then
        echo -e "${RED}ERROR: The kubectl binary does not exist.${NC}"
        echo -e "${YELLOW}FIX: Please ensure kubectl is installed and in your PATH.${NC}"
        exit 1
    fi
}

# Function to check kubectl connectivity
check_kubectl_access() {
    if ! ${KUBECTL} cluster-info &>/dev/null; then
        echo -e "${RED}ERROR: Cannot connect to Kubernetes cluster.${NC}"
        echo -e "${YELLOW}FIX: Please ensure kubectl is configured correctly and you have cluster access.${NC}"
        exit 1
    fi
}

# Function to convert memory values to bytes for sorting
convert_to_bytes() {
    local value=$1
    local unit=$(echo "$value" | sed 's/[0-9.]//g' | tr '[:lower:]' '[:upper:]')
    local num=$(echo "$value" | sed 's/[^0-9.]//g')
    
    case "$unit" in
        "KI"|"K")
            echo "$num * 1024" | bc
            ;;
        "MI"|"M")
            echo "$num * 1024 * 1024" | bc
            ;;
        "GI"|"G")
            echo "$num * 1024 * 1024 * 1024" | bc
            ;;
        "TI"|"T")
            echo "$num * 1024 * 1024 * 1024 * 1024" | bc
            ;;
        *)
            # Assume bytes if no unit
            echo "$num"
            ;;
    esac
}

# Function to find reserved memory
find_reserved_memory() {
    local namespace_arg=""
    local sort_flag=false
    
    # Parse command line arguments
    while getopts ':n:ash' opt; do
        case "$opt" in
            n)
                namespace_arg="-n ${OPTARG}"
                ;;
            a)
                namespace_arg="--all-namespaces"
                ;;
            s)
                sort_flag=true
                ;;
            h)
                Help
                exit 0
                ;;
            \?)
                echo -e "${RED}Invalid option: -$OPTARG${NC}" >&2
                Help
                exit 1
                ;;
            :)
                echo -e "${RED}Option -$OPTARG requires an argument.${NC}" >&2
                Help
                exit 1
                ;;
        esac
    done
    
    # Default to all namespaces if no namespace specified
    if [ -z "$namespace_arg" ]; then
        namespace_arg="--all-namespaces"
    fi
    
    # Check if bc is available for sorting
    if [ "$sort_flag" = true ] && ! command -v bc &>/dev/null; then
        echo -e "${YELLOW}WARNING: 'bc' not found. Sorting disabled. Install bc for size-based sorting.${NC}"
        sort_flag=false
    fi
    
    echo -e "${BLUE}Searching for pods with reserved memory (memory requests)...${NC}"
    echo
    
    # Get all pods with memory requests
    # Using JSON output to parse more reliably
    local pods_json
    pods_json=$(${KUBECTL} get pods ${namespace_arg} -o json 2>/dev/null)
    
    if [ $? -ne 0 ]; then
        echo -e "${RED}ERROR: Failed to query Kubernetes cluster.${NC}"
        exit 1
    fi
    
    # Check if jq is available for JSON parsing
    if ! command -v jq &>/dev/null; then
        echo -e "${YELLOW}WARNING: 'jq' not found. Using basic parsing.${NC}"
        echo -e "${YELLOW}For better output, install jq.${NC}"
        echo
        
        # Fallback to basic kubectl output
        echo -e "${CYAN}NAMESPACE${NC}\t${CYAN}POD${NC}\t\t\t${CYAN}CONTAINER${NC}\t\t${CYAN}MEMORY REQUEST${NC}"
        echo "--------------------------------------------------------------------------------------------------------"
        ${KUBECTL} get pods ${namespace_arg} -o custom-columns=NAMESPACE:.metadata.namespace,NAME:.metadata.name,CONTAINER:.spec.containers[*].name,MEMORY-REQUEST:.spec.containers[*].resources.requests.memory 2>/dev/null | \
            grep -v "MEMORY-REQUEST.*<none>" | \
            awk 'NR>1 {print $0}'
        return
    fi
    
    # Fetch actual memory usage (requires metrics-server)
    local usage_file
    usage_file=$(mktemp)
    local top_output
    top_output=$(${KUBECTL} top pods ${namespace_arg} --containers 2>/dev/null)
    if [ $? -eq 0 ] && [ -n "$top_output" ]; then
        echo "$top_output" | tail -n +2 | while IFS= read -r line; do
            local ns p c mem
            ns=$(echo "$line" | awk '{print $1}')
            p=$(echo "$line" | awk '{print $2}')
            c=$(echo "$line" | awk '{print $3}')
            mem=$(echo "$line" | awk '{print $NF}')
            [ -n "$ns" ] && [ -n "$p" ] && [ -n "$c" ] && [ -n "$mem" ] && echo "${ns}|${p}|${c}|${mem}"
        done > "$usage_file"
    fi

    # Use jq for better parsing
    # Print header
    printf "${CYAN}%-20s %-40s %-30s %-15s %-15s${NC}\n" "NAMESPACE" "POD" "CONTAINER" "USAGE" "RESERVED"
    echo "--------------------------------------------------------------------------------------------------------"
    echo -e "${YELLOW}(Rows in red: >25% discrepancy between actual usage and reserved)${NC}"
    echo
    
    # Helper to look up usage for a namespace/pod/container
    get_usage() {
        local ns=$1 pod=$2 cont=$3
        if [ -f "$usage_file" ] && [ -s "$usage_file" ]; then
            local found
            found=$(awk -F'|' -v ns="$ns" -v pod="$pod" -v cont="$cont" '$1==ns && $2==pod && $3==cont {print $4; exit}' "$usage_file")
            echo "${found:--}"
        else
            echo "-"
        fi
    }

    # Print a row, highlighting in RED if discrepancy between usage and reserved > 25%
    print_row() {
        local namespace=$1 pod_name=$2 container_name=$3 usage=$4 memory_request=$5
        local highlight=false
        if [ "$usage" != "-" ] && [ -n "$memory_request" ] && command -v bc &>/dev/null; then
            local usage_bytes reserved_bytes
            usage_bytes=$(convert_to_bytes "$usage")
            reserved_bytes=$(convert_to_bytes "$memory_request")
            if [ -n "$usage_bytes" ] && [ -n "$reserved_bytes" ] && [ "${reserved_bytes:-0}" -gt 0 ] 2>/dev/null; then
                local diff_pct
                diff_pct=$(echo "a=100*(${usage_bytes}-${reserved_bytes})/${reserved_bytes}; if(a<0) a=-a; a" | bc 2>/dev/null)
                if [ -n "$diff_pct" ]; then
                    local is_gt
                    is_gt=$(echo "$diff_pct > 25" | bc 2>/dev/null)
                    [ "$is_gt" = "1" ] && highlight=true
                fi
            fi
        fi
        if [ "$highlight" = true ]; then
            printf "${RED}%-20s %-40s %-30s %-15s %-15s${NC}\n" "$namespace" "$pod_name" "$container_name" "$usage" "$memory_request"
        else
            printf "%-20s %-40s %-30s %-15s %-15s\n" "$namespace" "$pod_name" "$container_name" "$usage" "$memory_request"
        fi
    }

    # Extract and display pod information
    if [ "$sort_flag" = true ]; then
        # Sort by memory size (requires conversion)
        # Create temporary file for sorting
        local temp_file=$(mktemp)
        
        echo "$pods_json" | jq -r '
            .items[] | 
            .metadata.namespace as $ns |
            .metadata.name as $pod |
            .spec.containers[]? | 
            select(.resources.requests.memory != null) |
            "\($ns)|\($pod)|\(.name)|\(.resources.requests.memory)"
        ' | while IFS='|' read -r namespace pod_name container_name memory_request; do
            if [ -n "$memory_request" ]; then
                memory_bytes=$(convert_to_bytes "$memory_request")
                printf "%s|%s|%s|%s|%s\n" "$memory_bytes" "$namespace" "$pod_name" "$container_name" "$memory_request" >> "$temp_file"
            fi
        done
        
        # Sort and display
        if [ -f "$temp_file" ] && [ -s "$temp_file" ]; then
            sort -t'|' -rn -k1 "$temp_file" | while IFS='|' read -r _ namespace pod_name container_name memory_request; do
                usage=$(get_usage "$namespace" "$pod_name" "$container_name")
                print_row "$namespace" "$pod_name" "$container_name" "$usage" "$memory_request"
            done
            rm -f "$temp_file"
        fi
    else
        # Display without sorting
        echo "$pods_json" | jq -r '
            .items[] | 
            .metadata.namespace as $ns |
            .metadata.name as $pod |
            .spec.containers[]? | 
            select(.resources.requests.memory != null) |
            "\($ns)|\($pod)|\(.name)|\(.resources.requests.memory)"
        ' | while IFS='|' read -r namespace pod_name container_name memory_request; do
            if [ -n "$memory_request" ]; then
                usage=$(get_usage "$namespace" "$pod_name" "$container_name")
                print_row "$namespace" "$pod_name" "$container_name" "$usage" "$memory_request"
            fi
        done
    fi
    
    rm -f "$usage_file"
    
    # Count total containers with reserved memory
    local count=$(echo "$pods_json" | jq '[.items[] | .spec.containers[]? | select(.resources.requests.memory != null)] | length')
    
    echo
    echo -e "${GREEN}Found ${count} container(s) with reserved memory${NC}"
}

# Main execution
check_binaries
check_kubectl_access

# If no arguments provided, show all namespaces
if [ $# -eq 0 ]; then
    find_reserved_memory -a
else
    find_reserved_memory "$@"
fi
